function i(o,t=!1){let e=o.touches[0];return{x:t?e.pageX:e.clientX,y:t?e.pageY:e.clientY}}function _(o,t,e){for(let n=0;n<e.length;n++){let s=e[n];o[s]=t[s]}}function f(o,t,e){let n=["altKey","ctrlKey","metaKey","shiftKey"],s=["pageX","pageY","clientX","clientY","screenX","screenY","offsetX","offsetY"],a=new Event(o,{bubbles:!0,cancelable:!0}),h=t.touches[0];return a.button=0,a.which=a.buttons=1,_(a,t,n),_(a,h,s),y(a,e),a}function y(o,t){let e=t.getBoundingClientRect();o.offsetX===void 0&&(o.offsetX=o.clientX-e.x,o.offsetY=o.clientY-e.y),o.layerX===void 0&&(o.layerX=o.pageX-e.left,o.layerY=o.pageY-e.top)}function u(o,t){if(T(t),o instanceof HTMLCanvasElement){let e=t;e.width=o.width,e.height=o.height,e.getContext("2d").drawImage(o,0,0)}E(o,t),t.style.pointerEvents="none";for(let e=0;e<o.children.length;e++)u(o.children[e],t.children[e])}function E(o,t){let e=getComputedStyle(o);for(let n of e)n.includes("transition")||(t.style[n]=e[n]);Object.keys(t.dataset).forEach(n=>delete t.dataset[n])}function T(o){["id","class","style","draggable"].forEach(function(t){o.removeAttribute(t)})}var r=class{_dropEffect;_effectAllowed;_data;_dragDropTouch;constructor(t){this._dropEffect="move",this._effectAllowed="all",this._data={},this._dragDropTouch=t}get dropEffect(){return this._dropEffect}set dropEffect(t){this._dropEffect=t}get effectAllowed(){return this._effectAllowed}set effectAllowed(t){this._effectAllowed=t}get types(){return Object.keys(this._data)}clearData(t){t!==null?delete this._data[t.toLowerCase()]:this._data={}}getData(t){let e=t.toLowerCase(),n=this._data[e];return e==="text"&&n==null&&(n=this._data["text/plain"]),n}setData(t,e){this._data[t.toLowerCase()]=e}setDragImage(t,e,n){this._dragDropTouch.setDragImage(t,e,n)}};var{round:m}=Math,D={allowDragScroll:!0,contextMenuDelayMS:900,dragImageOpacity:.5,dragScrollPercentage:10,dragScrollSpeed:10,dragThresholdPixels:5,forceListen:!1},g=class{_dragRoot;_dropRoot;_dragSource;_lastTouch;_lastTarget;_ptDown;_isDragEnabled;_isDropZone;_dataTransfer;_img;_imgCustom;_imgOffset;configuration;constructor(t=document,e=document,n){for(this.configuration={...D,...n||{}},this._dragRoot=t,this._dropRoot=e;!this._dropRoot.elementFromPoint&&this._dropRoot.parentNode;)this._dropRoot=this._dropRoot.parentNode;this._dragSource=null,this._lastTouch=null,this._lastTarget=null,this._ptDown=null,this._isDragEnabled=!1,this._isDropZone=!1,this._dataTransfer=new r(this),this._img=null,this._imgCustom=null,this._imgOffset={x:0,y:0},this.listen()}listen(){if(navigator.maxTouchPoints===0&&!this.configuration.forceListen)return;let t={passive:!1,capture:!1};this._dragRoot.addEventListener("touchstart",this._touchstart.bind(this),t),this._dragRoot.addEventListener("touchmove",this._touchmove.bind(this),t),this._dragRoot.addEventListener("touchend",this._touchend.bind(this)),this._dragRoot.addEventListener("touchcancel",this._touchend.bind(this))}setDragImage(t,e,n){this._imgCustom=t,this._imgOffset={x:e,y:n}}_touchstart(t){if(this._shouldHandle(t)){this._reset();let e=this._closestDraggable(t.target);e&&t.target&&!this._dispatchEvent(t,"mousemove",t.target)&&!this._dispatchEvent(t,"mousedown",t.target)&&(this._dragSource=e,this._ptDown=i(t),this._lastTouch=t,setTimeout(()=>{this._dragSource===e&&this._img===null&&this._dispatchEvent(t,"contextmenu",e)&&this._reset()},this.configuration.contextMenuDelayMS),t.isTrusted||t.target!==this._lastTarget&&(this._lastTarget=t.target))}}_touchmove(t){if(this._shouldHandle(t)){let e=this._getTarget(t);if(this._dispatchEvent(t,"mousemove",e)){this._lastTouch=t,t.preventDefault();return}if(this._dragSource&&!this._img&&this._shouldStartDragging(t)){if(this._dispatchEvent(this._lastTouch,"dragstart",this._dragSource)){this._dragSource=null;return}this._createImage(t),this._dispatchEvent(t,"dragenter",e)}if(this._img&&this._dragSource&&(this._lastTouch=t,t.preventDefault(),this._dispatchEvent(t,"drag",this._dragSource),e!==this._lastTarget&&(this._lastTarget&&this._dispatchEvent(this._lastTouch,"dragleave",this._lastTarget),this._dispatchEvent(t,"dragenter",e),this._lastTarget=e),this._moveImage(t),this._isDropZone=this._dispatchEvent(t,"dragover",e),this.configuration.allowDragScroll)){let n=this._getHotRegionDelta(t);globalThis.scrollBy(n.x,n.y)}this._dragSource&&t.preventDefault()}}_touchend(t){if(!(this._lastTouch&&t.target&&this._lastTarget)){this._reset();return}if(this._shouldHandle(t)){if(this._dispatchEvent(this._lastTouch,"mouseup",t.target)){t.preventDefault();return}this._img||(this._dragSource=null,this._dispatchEvent(this._lastTouch,"click",t.target)),this._destroyImage(),this._dragSource&&(t.type.indexOf("cancel")<0&&this._isDropZone&&this._dispatchEvent(this._lastTouch,"drop",this._lastTarget),this._dispatchEvent(this._lastTouch,"dragend",this._dragSource),this._reset())}}_shouldHandle(t){return t&&!t.defaultPrevented&&t.touches&&t.touches.length<2}_shouldStartDragging(t){return this._getDelta(t)>this.configuration.dragThresholdPixels}_reset(){this._destroyImage(),this._dragSource=null,this._lastTouch=null,this._lastTarget=null,this._ptDown=null,this._isDragEnabled=!1,this._isDropZone=!1,this._dataTransfer=new r(this)}_getDelta(t){if(!this._ptDown)return 0;let{x:e,y:n}=this._ptDown,s=i(t);return((s.x-e)**2+(s.y-n)**2)**.5}_getHotRegionDelta(t){let{clientX:e,clientY:n}=t.touches[0],{innerWidth:s,innerHeight:a}=globalThis,{dragScrollPercentage:h,dragScrollSpeed:l}=this.configuration,c=h/100,d=1-c,p=e<s*c?-l:e>s*d?+l:0,v=n<a*c?-l:n>a*d?+l:0;return{x:p,y:v}}_getTarget(t){let e=i(t),n=this._dropRoot.elementFromPoint(e.x,e.y);for(;n&&getComputedStyle(n).pointerEvents=="none";)n=n.parentElement;return n}_createImage(t){this._img&&this._destroyImage();let e=this._imgCustom||this._dragSource;if(this._img=e.cloneNode(!0),u(e,this._img),this._img.style.top=this._img.style.left="-9999px",!this._imgCustom){let n=e.getBoundingClientRect(),s=i(t);this._imgOffset={x:s.x-n.left,y:s.y-n.top},this._img.style.opacity=`${this.configuration.dragImageOpacity}`}this._moveImage(t),document.body.appendChild(this._img)}_destroyImage(){this._img&&this._img.parentElement&&this._img.parentElement.removeChild(this._img),this._img=null,this._imgCustom=null}_moveImage(t){requestAnimationFrame(()=>{if(this._img){let e=i(t,!0),n=this._img.style;n.position="absolute",n.pointerEvents="none",n.zIndex="999999",n.left=`${m(e.x-this._imgOffset.x)}px`,n.top=`${m(e.y-this._imgOffset.y)}px`}})}_dispatchEvent(t,e,n){if(!(t&&n))return!1;let s=f(e,t,n);return s.dataTransfer=this._dataTransfer,n.dispatchEvent(s),s.defaultPrevented}_closestDraggable(t){for(let e=t;e!==null;e=e.parentElement)if(e.draggable)return e;return null}};function L(o=document,t=document,e){new g(o,t,e)}export{L as enableDragDropTouch};
